# Домашнее задание к занятию «Резервное копирование баз данных». Шелухин Юрий.

**Домашнее задание выполните в Google Docs или в md-файле в вашем репозитории GitHub.** 

Для оформления вашего решения в GitHub можете воспользоваться [шаблоном](https://github.com/netology-code/sys-pattern-homework).
Название файла должно содержать номер лекции и фамилию студента. Пример названия: «12.8. Резервное копирование баз данных — Александр Александров».
Перед тем как выслать ссылку, убедитесь, что её содержимое не является приватным, то есть открыто на просмотр всем, у кого есть ссылка. Если необходимо прикрепить дополнительные ссылки, просто добавьте их в свой Google Docs.
Любые вопросы по решению задач задавайте в чате учебной группы.

---


### Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. 
Необходимо описать, какие варианты резервного копирования подходят в случаях: 

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.  
1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.  
1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.  

*Приведите ответ в свободной форме.*


**Решение.**
 
1.1. Есть два варианта решения.   
Первый - делать полный бэкап данных за сутки, например в час ночи, и при неоходимости его восстанавливать. Но это повлечет временные затраты и высокую нагрузку на оборудование, что критично при высоко нагруженных сервисах. Преимущество- полнота данных и простота восстановления.    
Второй - делать полный бэкап раз в неделю  в наименее нагруженное время, например, в понедельник в час ночи,  и ежедневно инкрементный (дифференциальный) бэкап, тоже ночью. При необходимости восстановления данных в полном объеме за заданный день можно будет использовать последний полный бэкап и дельты. К недостаткам второго способа отнесем длительность восстановления и риск утраты данных за один из дней.
 
1.2.  В этом случае целесообразно делать полный бэкап раз в день ежедневно, в наименее нагруженное время, например в час ночи, а инкрементный (дифференциальный) бэкап каждый час. При необходимости восстановления данных в полном объеме на заданный час можно будет использовать последний полный бэкап и дельты. К недостаткам второго способа вновь отнесем длительность восстановления и риск утраты данных за один из дней.  Также можно предусмотреть репликацию.

1.3. Такой вариант возможен в рамках репликации. При обрушении мастера базы можно тспользовать комплексную стратегию.  1. Бд бэкапится полность еженедельно или ежедневно, и инкрементально ежедневно или ежечасно, в зпвисимости от требований организации и условий рабоьоспособности. Осуществляется репликация (2+ узла), утановлен load-balancer, осуществляется мониторинг (нealth checks каждые 5-10 секунд). В случае сбоя на мастере сервис автоматически переводится на слейв, и это время на мастер-инстанц вручную восстанавливается информация.При необходимсти накатывается БД из бэкапов или с работающего слейва.

---


### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).  
2.2.* Возможно ли автоматизировать этот процесс? Если да, то как?

*Приведите ответ в свободной форме.*


**Решение.**  

2.1. Для резервного копирования и восстановления базы данных в PostgreSQL используются утилиты pg_dump и pg_restore. Процесс можно автоматизировать с помощью скриптов и планировщика заданий.  
Например, `pg_dump -U postgres test > /backup/new.sql (pg_dumpall  - для полного бэкапа)`, `pg_restore -U postgres -h localhost -C -d postgres mydatabase_backup.dump`

2.2. Можно использовать скрипт копирования бэкапа, который будет запускаться через cron. Пример скрипта:
`#!/bin/bash`  
`DB_NAME="test_db"`  
`DB_USER="test"`  
`BACKUP_DIR="/path/to/your/backup/  directory"`  
`DATE_STAMP=$(date +%Y-%m-%d_%H-%M-%S)`  
`pg_dump -U $DB_USER -h localhost -Fc $DB_NAME -f $BACKUP_DIR/${DB_NAME}_${DATE_STAMP}.dump`  
`find $BACKUP_DIR -name "*.dump" -mtime +30 -delete`  

Строка в cron:
`0 2 * * * /path/to/your/backup_script.sh`

Для автоматического воостановления скрипт нужно дополнить секциями отслеживания логов и восстановления бэкапа.

---

### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL.   
3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

*Приведите ответ в свободной форме.*


**Решение.**

3.1. Двоичный журнал (binlog) Mysql содержит все изменения данных в базе. Для настройки инкрементного резервного копирования нужно активировать ведение этих логов в конфигурационном файле MySQL (my.cnf или my.ini):
`ini`  
`[mysqld]`  
`log-bin = /var/log/mysql/mysql-bin.log`  
`expire_logs_days = 7`  
`max_binlog_size = 100M`  

После перезагрузки сервиса MySQL, нужно создать полную резервную копию с помощью mysqldump с ключами `--flush-logs` и `--delete-master-logs`, которые архивируют текущие двоичные логи и начнут новый файл.    
`mysqldump --flush-logs --delete-master-logs --single-transaction --all-databases | gzip > /backups/full_backup_$(date +%d-%m-%Y).sql.gz`

Для создания инкрементного бэкапа нужно сохранить двоичные логи, созданные после полной копии: выполнить команду для создания нового файла журнала, затем скопировать предыдущие файлы.

`mysql -E --execute='FLUSH BINARY LOGS;' mysql`

3.2. Репликация и резервное копирование служат для повышения надежности системы, но, дополняя друг друга, решают разные задачи и дают преимущества в различных сценариях.
Репликация повышает доступность и масштабируемость, снижает время простоя системы, позволяет распределить нагрузку, перенаправив запросы на чтение на реплику(и), а кроме того позволяет иметь на репликах почти или полностью актуальные данные.  


---



